<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>架空言語辞書アプリ</title>
    <style>
        body {
            font-family: "Maru Gothic", sans-serif;
        }
        .dictionary-entry {
            border: 1px solid #009999;
            background-color: #00BBBB;
            margin: 10px;
            padding: 10px;
        }
        .dictionary-entry h3 {
            font-family: "Maru Gothic", sans-serif;
        }
        .example {
            border: 1px solid #009999;
            background-color: #00BBBB;
            padding: 5px;
            margin-top: 5px;
        }
        button {
            background-color: #00aa00;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        #loginStatus {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>架空言語辞書アプリ</h1>
    <div id="loginStatus"></div>

    <div id="loginPanel">
        <label for="userId">ユーザーID:</label>
        <input type="text" id="userId"><br>
        <label for="password">パスワード:</label>
        <input type="password" id="password"><br>
        <button onclick="login()">ログイン</button>
    </div>

    <div id="app" style="display: none;">
        <div id="userInfo"></div>
        <h2>グループ</h2>
        <div id="groupInfo"></div>

        <p id="currentDictionary">現在の辞書: <span id="dictionaryName"></span></p>
        <p>単語数: <span id="wordCount"></span></p>
        <p>ページ: <span id="currentPage"></span></p>
        
        <input type="file" id="fontUpload" accept=".ttf,.otf,.woff">
        <input type="file" id="otmJsonUpload" accept=".json">
        <button onclick="uploadFont()">フォントアップロード</button>
        <button onclick="uploadOtmJson()">OTM JSONアップロード</button>
        <button onclick="saveDictionary()">辞書を保存</button>
        <button onclick="logout()">ログアウト</button>

        <h2>単語追加</h2>
        <form id="addWordForm">
            <label for="word">単語:</label>
            <input type="text" id="word" required><br>
            <label for="definition">定義:</label>
            <input type="text" id="definition" required><br>
            <label for="examples">例文:</label>
            <input type="text" id="examples"><br>
            <label for="pronunciation">発音:</label>
            <input type="text" id="pronunciation"><br>
            <label for="tags">タグ:</label>
            <input type="text" id="tags"><br>
            <label for="pos">品詞:</label>
            <input type="text" id="pos"><br>
            <label for="relatedWords">関連語:</label>
            <input type="text" id="relatedWords"><br>
            <button type="button" onclick="addWord()">追加</button>
        </form>
        
        <h2>検索</h2>
        <input type="text" id="searchInput">
        <button onclick="searchWords('complete')">完全一致検索</button>
        <button onclick="searchWords('prefix')">前方一致検索</button>
        <button onclick="searchWords('partial')">部分一致検索</button>

        <div id="dictionaryEntries"></div>
        
        <button onclick="prevPage()">戻る</button>
        <button onclick="nextPage()">進む</button>
    </div>

    <script>
        let dictionary = [];
        let currentPage = 1;
        const entriesPerPage = 20;
        let loggedIn = false;
        let currentUser = null;
        let currentGroup = null;

        function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;

            // ユーザー認証の実装 (仮)
            if (userId && password) {
                // 本来はここでユーザーとグループのデータを取得する処理を行う
                currentUser = { id: userId };
                currentGroup = { id: 'default', name: 'デフォルトグループ' };

                loggedIn = true;
                document.getElementById('loginPanel').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('loginStatus').innerText = `ログイン中: ${userId}`;

                // ユーザー情報とグループ情報の表示
                displayUserInfo();
                displayGroupInfo();
            } else {
                alert('ユーザーIDとパスワードを入力してください。');
            }
        }

        function logout() {
            loggedIn = false;
            currentUser = null;
            currentGroup = null;
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginPanel').style.display = 'block';
            document.getElementById('loginStatus').innerText = '';
        }

        function displayUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            if (currentUser) {
                userInfoDiv.innerHTML = `
                    <p>ユーザーID: ${currentUser.id}</p>
                    <p>編集権限: ${currentUser.editPermission ? 'あり' : 'なし'}</p>
                    <p>管理権限: ${currentUser.adminPermission ? 'あり' : 'なし'}</p>
                `;
            }
        }

        function displayGroupInfo() {
            const groupInfoDiv = document.getElementById('groupInfo');
            if (currentGroup) {
                groupInfoDiv.innerHTML = `
                    <p>グループID: ${currentGroup.id}</p>
                    <p>グループ名: ${currentGroup.name}</p>
                    <p>ICDE: ${currentGroup.icde}</p>
                `;
            }
        }

        function uploadFont() {
            const fileInput = document.getElementById('fontUpload');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const fontFace = new FontFace('UploadedFont', e.target.result);
                document.fonts.add(fontFace);
                fontFace.load().then(() => {
                    document.body.style.fontFamily = 'UploadedFont, sans-serif';
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function uploadOtmJson() {
            const fileInput = document.getElementById('otmJsonUpload');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                dictionary = data.words;
                displayDictionary();
            };
            reader.readAsText(file);
        }

        function addWord() {
            if (!loggedIn) {
                alert('ログインしてください。');
                return;
            }

            const word = document.getElementById('word').value;
            const definition = document.getElementById('definition').value;
            const examples = document.getElementById('examples').value.split(',');
            const pronunciation = document.getElementById('pronunciation').value;
            const tags = document.getElementById('tags').value.split(',');
            const pos = document.getElementById('pos').value;
            const relatedWords = document.getElementById('relatedWords').value.split(',').map(word => ({ form: word.trim(), id: generateId() }));

            const newEntry = {
                entry: {
                    id: generateId(),
                    form: word
                },
                translations: [{ title: "definition", forms: [definition] }],
                tags,
                contents: [{ title: pos, text: definition }],
                variations: [],
                relations: relatedWords.map(word => ({ title: "related", entry: word }))
            };
            dictionary.push(newEntry);
            displayDictionary();
        }

        function searchWords(type) {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            let filteredDictionary = [];

            switch (type) {
                case 'complete':
                    filteredDictionary = dictionary.filter(entry => entry.entry.form.toLowerCase() === searchInput);
                    break;
                case 'prefix':
                    filteredDictionary = dictionary.filter(entry => entry.entry.form.toLowerCase().startsWith(searchInput));
                    break;
                case 'partial':
                    filteredDictionary = dictionary.filter(entry => entry.entry.form.toLowerCase().includes(searchInput));
                    break;
            }
            displayDictionary(filteredDictionary);
        }

        function saveDictionary() {
            if (!loggedIn) {
                alert('ログインしてください。');
                return;
            }

            const data = {
                words: dictionary,
                version: 2,
                settings: {
                    zpdic: {
                        punctuationTitle: "punctuations",
                        pronunciationTitle: "発音"
                    },
                    zpdicOnline: {
                        explanation: "これは架空言語の辞書です。",
                        enableMarkdown: false
                    }
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dictionary.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function displayDictionary(entries = dictionary) {
            const dictionaryEntriesDiv = document.getElementById('dictionaryEntries');
            dictionaryEntriesDiv.innerHTML = '';

            entries.slice((currentPage - 1) * entriesPerPage, currentPage * entriesPerPage).forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.classList.add('dictionary-entry');

                const entryContent = `
                    <h3>${entry.entry.form}</h3>
                    <p>${entry.translations.map(translation => translation.forms.join(', ')).join('<br>')}</p>
                    <div class="example">${entry.contents.map(content => content.text).join('<br>')}</div>
                    <p>${entry.tags.join(', ')}</p>
                    <p>関連語: ${entry.relations.map(relation => relation.entry.form).join(', ')}</p>
                `;
                entryDiv.innerHTML = entryContent;

                dictionaryEntriesDiv.appendChild(entryDiv);
            });

            document.getElementById('wordCount').innerText = dictionary.length;
            document.getElementById('currentPage').innerText = currentPage;
            document.getElementById('dictionaryName').innerText = 'デフォルト辞書';
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayDictionary();
            }
        }

        function nextPage() {
            const maxPage = Math.ceil(dictionary.length / entriesPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                displayDictionary();
            }
        }

        function generateId() {
            return Math.floor(Math.random() * 100000);
        }

        // 初期表示
        displayDictionary();
    </script>
</body>
</html>
